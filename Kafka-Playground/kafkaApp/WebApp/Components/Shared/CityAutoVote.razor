@using WebApp.Services
@implements IDisposable

<div class="card h-100 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <strong>@Controller.Topic.City</strong>
            <div class="text-muted small">@Controller.Topic.DisplayName</div>
        </div>
        <span class="@StatusBadgeClass">@StatusLabel</span>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <label class="form-label">
                Target rate: <strong>@Controller.TargetPerMinute.ToString("N0")</strong> votes / minute
            </label>
         <input type="range"
             class="form-range"
             min="0"
             max="@CityAutoVoteController.MaxVotesPerMinute"
             step="100"
             @bind="TargetPerMinute"
             @bind:event="oninput" />
        </div>

        <div class="mb-3 d-flex align-items-center flex-wrap gap-2">
            <button class="btn @(Controller.IsRunning ? "btn-danger" : "btn-success")"
                    @onclick="ToggleAsync">
                @(Controller.IsRunning ? "Stop" : "Start")
            </button>
            <span class="text-muted">
                Actual: <strong>@Controller.ActualPerMinute.ToString("N0")</strong> / minute
            </span>
            <span class="text-muted ms-md-3">
                Total sent: @Controller.TotalSent.ToString("N0")
            </span>
        </div>

        @if (!string.IsNullOrWhiteSpace(_lastError))
        {
            <div class="alert alert-danger py-2 mb-0">
                @_lastError
            </div>
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public CityAutoVoteController Controller { get; set; } = default!;

    private string? _lastError;

    protected override void OnInitialized()
    {
        Controller.StatusChanged += HandleStatusChanged;
        _lastError = Controller.LastError;
    }

    private string StatusLabel => Controller.IsRunning ? "Running" : "Stopped";

    private string StatusBadgeClass => Controller.IsRunning ? "badge bg-success" : "badge bg-secondary";

    private async Task ToggleAsync()
    {
        if (Controller.IsRunning)
        {
            await Controller.StopAsync();
        }
        else
        {
            Controller.Start();
        }
    }

    private int TargetPerMinute
    {
        get => Controller.TargetPerMinute;
        set => Controller.SetTargetRate(value);
    }

    private void HandleStatusChanged(CityAutoVoteController controller)
    {
        _ = InvokeAsync(() =>
        {
            _lastError = controller.LastError;
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        Controller.StatusChanged -= HandleStatusChanged;
    }
}
