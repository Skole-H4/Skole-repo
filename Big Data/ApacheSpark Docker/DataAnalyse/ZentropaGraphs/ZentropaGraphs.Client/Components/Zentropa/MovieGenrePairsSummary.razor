@inject HttpClient Http

@if (_error is not null)
{
    <div class="alert alert-danger">Failed to analyse movie&ndash;genre pairs: @_error</div>
}
else if (_genreSummary is null)
{
    <div class="alert alert-info">Crunching movie&ndash;genre pairs...</div>
}
else
{
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 m-0">Catalogue Genre Coverage</h2>
        </div>
        <div class="card-body">
            <div class="row text-center mb-3">
                <div class="col">
                    <div class="fw-bold">Pairs</div>
                    <div>@_totalPairs.ToString("#,##0")</div>
                </div>
                <div class="col">
                    <div class="fw-bold">Unique Movies</div>
                    <div>@_uniqueMovies.ToString("#,##0")</div>
                </div>
                <div class="col">
                    <div class="fw-bold">Genres</div>
                    <div>@_genreSummary.Count.ToString("#,##0")</div>
                </div>
            </div>
            <h3 class="h6">Genres with the broadest catalogue</h3>
            <div class="table-responsive mb-3">
                <table class="table table-sm align-middle mb-0">
                    <thead>
                        <tr>
                            <th scope="col">Genre</th>
                            <th scope="col" class="text-end">Movies</th>
                            <th scope="col" class="text-end">Pairs</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in _genreSummary)
                        {
                            <tr>
                                <th scope="row">@row.Genre</th>
                                <td class="text-end">@row.UniqueMovies.ToString("#,##0")</td>
                                <td class="text-end">@row.TotalPairs.ToString("#,##0")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <h3 class="h6">Most cross-genre titles</h3>
            <div class="table-responsive mb-0">
                <table class="table table-sm align-middle mb-0">
                    <thead>
                        <tr>
                            <th scope="col">Title</th>
                            <th scope="col" class="text-end">Genres</th>
                            <th scope="col">List</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var movie in _topHybridMovies)
                        {
                            <tr>
                                <th scope="row">@movie.Title</th>
                                <td class="text-end">@movie.Genres.Count</td>
                                <td>@string.Join(", ", movie.Genres)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@code {
    private IReadOnlyList<GenreSummaryRow>? _genreSummary;
    private IReadOnlyList<MovieGenreSummary> _topHybridMovies = Array.Empty<MovieGenreSummary>();
    private string? _error;
    private int _totalPairs;
    private int _uniqueMovies;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await using var stream = await Http.GetStreamAsync("ZentropaData/movie_genre_pairs.json");
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };            
            var genreMovieIds = new Dictionary<string, HashSet<int>>(StringComparer.OrdinalIgnoreCase);
            var genrePairCounts = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
            var movieBuckets = new Dictionary<int, MovieGenreAccumulator>();

            await foreach (var item in JsonSerializer.DeserializeAsyncEnumerable<MovieGenrePair>(stream, options))
            {
                if (item is null)
                {
                    continue;
                }

                _totalPairs++;

                if (!genreMovieIds.TryGetValue(item.genre, out var movieSet))
                {
                    movieSet = new HashSet<int>();
                    genreMovieIds[item.genre] = movieSet;
                }

                movieSet.Add(item.movieId);

                if (genrePairCounts.ContainsKey(item.genre))
                {
                    genrePairCounts[item.genre]++;
                }
                else
                {
                    genrePairCounts[item.genre] = 1;
                }

                if (!movieBuckets.TryGetValue(item.movieId, out var bucket))
                {
                    bucket = new MovieGenreAccumulator(item.movieId, item.title, new HashSet<string>(StringComparer.OrdinalIgnoreCase));
                    movieBuckets[item.movieId] = bucket;
                }

                bucket.Genres.Add(item.genre);
            }

            _uniqueMovies = movieBuckets.Count;

            _genreSummary = genreMovieIds
                .Select(pair => new GenreSummaryRow(pair.Key, pair.Value.Count, genrePairCounts[pair.Key]))
                .OrderByDescending(row => row.UniqueMovies)
                .ThenBy(row => row.Genre)
                .Take(15)
                .ToList();

            _topHybridMovies = movieBuckets.Values
                .OrderByDescending(bucket => bucket.Genres.Count)
                .ThenBy(bucket => bucket.Title, StringComparer.OrdinalIgnoreCase)
                .Take(10)
                .Select(bucket => new MovieGenreSummary(bucket.MovieId, bucket.Title, bucket.Genres.OrderBy(g => g, StringComparer.OrdinalIgnoreCase).ToList()))
                .ToList();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private sealed record MovieGenrePair(int movieId, string title, string genre);

    private sealed record GenreSummaryRow(string Genre, int UniqueMovies, int TotalPairs);

    private sealed record MovieGenreAccumulator(int MovieId, string Title, HashSet<string> Genres);

    private sealed record MovieGenreSummary(int MovieId, string Title, IReadOnlyList<string> Genres);
}
