@using WebApp.Services
@implements IDisposable

<div class="glass-card panel city-card">
    <header class="city-card__header panel-header--tight">
        <div>
            <span class="city-card__title">@Controller.Topic.City</span>
            <span class="city-card__subtitle">@Controller.Topic.DisplayName</span>
        </div>
        <span class="@StatusBadgeClass">
            <span class="status-pill__dot" aria-hidden="true"></span>
            @StatusLabel
        </span>
    </header>
    <div class="city-card__body">
        <div class="form-field">
            <label class="input-label">Target rate</label>
            <div class="city-card__stat">
                <span class="city-card__value">@Controller.TargetPerMinute.ToString("N0")</span>
                <span class="city-card__caption">votes / minute</span>
            </div>
            <input type="range"
                   class="form-range"
                   min="0"
                   max="@CityAutoVoteController.MaxVotesPerMinute"
                   step="100"
                   @bind="TargetPerMinute"
                   @bind:event="oninput" />
        </div>

        <div class="city-card__actions">
            <button class="btn @(Controller.IsRunning ? "btn-danger" : "btn-success")" @onclick="ToggleAsync">
                @(Controller.IsRunning ? "Stop" : "Start")
            </button>
            <div class="city-card__metrics">
                <span>Actual: <strong>@Controller.ActualPerMinute.ToString("N0")</strong>/min</span>
                <span>Total sent: @Controller.TotalSent.ToString("N0")</span>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(_lastError))
        {
            <div class="callout callout--error">@_lastError</div>
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public CityAutoVoteController Controller { get; set; } = default!;

    private string? _lastError;

    protected override void OnInitialized()
    {
        Controller.StatusChanged += HandleStatusChanged;
        _lastError = Controller.LastError;
    }

    private string StatusLabel => Controller.IsRunning ? "Running" : "Stopped";

    private string StatusBadgeClass => Controller.IsRunning ? "status-pill status-pill--live" : "status-pill status-pill--idle";

    private async Task ToggleAsync()
    {
        if (Controller.IsRunning)
        {
            await Controller.StopAsync();
        }
        else
        {
            Controller.Start();
        }
    }

    private int TargetPerMinute
    {
        get => Controller.TargetPerMinute;
        set => Controller.SetTargetRate(value);
    }

    private void HandleStatusChanged(CityAutoVoteController controller)
    {
        _ = InvokeAsync(() =>
        {
            _lastError = controller.LastError;
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        Controller.StatusChanged -= HandleStatusChanged;
    }
}
